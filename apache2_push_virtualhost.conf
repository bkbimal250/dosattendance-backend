# Apache2 Virtual Host Configuration for Push Data Reception
# This configuration handles attendance data pushed from biometric devices on port 8081

<VirtualHost *:8081>
    ServerName company.d0s369.co.in
    ServerAlias www.company.d0s369.co.in
    DocumentRoot /var/www/EmployeeAttendance

    # Enable required modules for proxy and headers
    LoadModule proxy_module modules/mod_proxy.so
    LoadModule proxy_http_module modules/mod_proxy_http.so
    LoadModule rewrite_module modules/mod_rewrite.so
    LoadModule headers_module modules/mod_headers.so

    # Security Headers for device communication
    Header always set X-Content-Type-Options nosniff
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"

    # Handle CORS preflight requests
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]

    # Django Application for Push Data
    WSGIDaemonProcess EmployeeAttendancePush python-home=/var/www/EmployeeAttendance/venv python-path=/var/www/EmployeeAttendance
    WSGIProcessGroup EmployeeAttendancePush
    WSGIScriptAlias / /var/www/EmployeeAttendance/attendance_system/wsgi.py

    # Django Application Directory
    <Directory /var/www/EmployeeAttendance/attendance_system>
        <Files wsgi.py>
            Require all granted
        </Files>
    </Directory>

    # Specific configuration for push endpoints
    <LocationMatch "^/api/device/">
        # Allow all devices to push data without authentication
        Require all granted
        
        # Set appropriate headers for device communication
        Header always set Content-Type "application/json"
        Header always set Cache-Control "no-cache, no-store, must-revalidate"
        
        # Log device requests
        CustomLog ${APACHE_LOG_DIR}/device_push_access.log combined
    </LocationMatch>

    # Health check endpoint
    <LocationMatch "^/api/device/health-check/">
        Require all granted
        CustomLog ${APACHE_LOG_DIR}/device_health_check.log combined
    </LocationMatch>

    # Logging for push data
    ErrorLog ${APACHE_LOG_DIR}/device_push_error.log
    CustomLog ${APACHE_LOG_DIR}/device_push_access.log combined

    # Security settings
    ServerTokens Prod
    ServerSignature Off
    
    # Allow large POST requests for bulk attendance data
    LimitRequestBody 10485760  # 10MB limit
</VirtualHost>

# Alternative configuration if you want to use a different port
# Uncomment and modify if needed
# <VirtualHost *:8080>
#     ServerName company.d0s369.co.in
#     DocumentRoot /var/www/EmployeeAttendance
#     
#     # Same configuration as above but for port 8080
#     WSGIDaemonProcess EmployeeAttendancePush python-home=/var/www/EmployeeAttendance/venv python-path=/var/www/EmployeeAttendance
#     WSGIProcessGroup EmployeeAttendancePush
#     WSGIScriptAlias / /var/www/EmployeeAttendance/attendance_system/wsgi.py
#     
#     <Directory /var/www/EmployeeAttendance/attendance_system>
#         <Files wsgi.py>
#             Require all granted
#         </Files>
#     </Directory>
#     
#     ErrorLog ${APACHE_LOG_DIR}/device_push_error.log
#     CustomLog ${APACHE_LOG_DIR}/device_push_access.log combined
# </VirtualHost>
